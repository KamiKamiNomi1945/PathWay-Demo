<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WebXR AR – Faste positioner</title>

  <!-- three.js (sen r15x+ virker fint) -->
  <script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
  <script src="https://unpkg.com/three@0.160.0/examples/jsm/webxr/ARButton.js"></script>

  <style>
    html,body { margin:0; height:100%; background:#000; color:#fff; font:14px/1.4 system-ui,sans-serif; }
    #hud { position:fixed; left:12px; bottom:12px; padding:8px 10px; background:rgba(0,0,0,.5); border:1px solid #333; border-radius:8px; }
    #start { position:fixed; left:50%; top:50%; transform:translate(-50%,-50%); padding:12px 16px; font-size:16px; }
    canvas { display:block; } /* three.js canvas */
  </style>
</head>
<body>
  <!-- Trech info nederst -->
  <div id="hud">Gå rundt. Objekter er låst til verdensrummet.</div>
  <!-- AR start-knap (indsættes/forbedres af ARButton) -->
  <button id="start">Start AR</button>

  <script type="module">
    // ------------------------------------------------------------
    // Scene, kamera og renderer
    // ------------------------------------------------------------
    const scene = new THREE.Scene();

    // Kameraet styres af WebXR; vi sætter stadig et kamera-objekt op:
    const camera = new THREE.PerspectiveCamera();
    scene.add(camera);

    const renderer = new THREE.WebGLRenderer({ antialias:true, alpha:true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    renderer.xr.enabled = true; // vigtig for WebXR
    document.body.appendChild(renderer.domElement);

    // En smule lys, så vi kan se noget
    scene.add(new THREE.HemisphereLight(0xffffff, 0x444444, 1.0));
    const dir = new THREE.DirectionalLight(0xffffff, 0.6);
    dir.position.set(1, 2, 1);
    scene.add(dir);

    // ------------------------------------------------------------
    // Faste verdens-objekter (position + rotation)
    // Verdens-aksen er i meter. Z negativ = "foran" oprindelsen.
    // Oprindelsen (0,0,0) vælges når AR-sessionen starter.
    // ------------------------------------------------------------
    function makeBox(size=0.2, color=0x00ffff) {
      const geo = new THREE.BoxGeometry(size, size, size);
      const mat = new THREE.MeshStandardMaterial({ color });
      const mesh = new THREE.Mesh(geo, mat);
      mesh.castShadow = mesh.receiveShadow = true;
      return mesh;
    }

    function makeTorus(r=0.15, t=0.05, color=0xff00ff) {
      const geo = new THREE.TorusGeometry(r, t, 16, 64);
      const mat = new THREE.MeshStandardMaterial({ color });
      return new THREE.Mesh(geo, mat);
    }

    // Objekt A: en kasse 1 meter foran startpunktet, 0.2 m oppe, vredet 45° om Y
    const box = makeBox(0.2, 0x00ffff);
    box.position.set(0, 0.2, -1.0);
    box.rotation.set(0, Math.PI / 4, 0); // Euler (X,Y,Z)
    scene.add(box);

    // Objekt B: en donut 1.5 m til venstre, 0.4 m oppe, 2 m fremme, 90° om X
    const torus = makeTorus(0.15, 0.05, 0xff0088);
    torus.position.set(-1.5, 0.4, -2.0);
    torus.rotation.set(Math.PI / 2, 0, 0);
    scene.add(torus);

    // (Valgfrit) Et lille gulvgrid til debug (vises ikke i AR kamera-feedet)
    // const grid = new THREE.GridHelper(10, 10);
    // scene.add(grid);

    // ------------------------------------------------------------
    // AR session start – reference space og render loop
    // ------------------------------------------------------------
    // Vi beder om 'local-floor', så gulvniveau estimeres.
    const sessionInit = { requiredFeatures: ['local-floor'] };

    // Start-knap via three.js’ ARButton (erstatter vores #start)
    const startBtn = document.getElementById('start');
    startBtn.replaceWith(THREE.ARButton.createButton(renderer, sessionInit));

    // Render-loop for XR
    renderer.setAnimationLoop((time, frame) => {
      // Her kunne man opdatere ankre/poses, hvis anchors bruges.
      // Vores objekter ligger allerede i verdensrummet, så vi tegner bare.
      torus.rotation.z += 0.01; // lille animation
      renderer.render(scene, camera);
    });

    // Håndter resize
    window.addEventListener('resize', () => {
      renderer.setSize(window.innerWidth, window.innerHeight);
    });

    // ------------------------------------------------------------
    // (Avanceret/fremtidigt) Anchors:
    // Hvis browseren understøtter WebXR Anchors, kan du "låse" objekter ekstra
    // robust til miljøet. Det kræver typisk:
    //
    // 1) sessionInit.requiredFeatures.push('anchors')
    // 2) inde i animation loop:
    //      const xr = renderer.xr.getSession();
    //      const refSpace = renderer.xr.getReferenceSpace();
    //      const xrFrame = renderer.xr.getFrame();
    //      const rigid = new XRRigidTransform(box.position, new DOMPointReadOnly(
    //        0, 0, 0, 1  // quaternion (w sidste)
    //      ));
    //      const anchor = xrFrame.createAnchor(rigid, refSpace);
    //      // derefter læs pose via anchor.anchorSpace for at opdatere objektet.
    //
    // Det er ikke nødvendigt for at have objekter "ikke-relative til kameraet",
    // men kan give mere stabil låsning i rummet.
    // ------------------------------------------------------------
  </script>
</body>
</html>
